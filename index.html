<!doctype html>
<meta charset=utf-8>
<title>Codegolf IDE</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.11.0/codemirror.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.11.0/codemirror.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.11.0/mode/xml/xml.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.11.0/mode/javascript/javascript.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.11.0/mode/css/css.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.11.0/mode/htmlmixed/htmlmixed.js"></script>
<script src="http://siorki.github.io/contextDescriptor_browser.js"></script>
<script src="http://siorki.github.io/packerData.js"></script>
<script src="http://siorki.github.io/shapeShifter.js"></script>
<script src="http://siorki.github.io/regPack.js"></script>
<script src="http://siorki.github.io/patternViewer.js"></script>
<style>
*{margin:0;padding:0;border:0;box-sizing:border-box}
html,body{height:100%}
.CodeMirror,#iframe{width:50%;height:100%;float:left;transition:.5s}
#iframe{border-left:1px solid}
#toggle{position:fixed;bottom:0;left:50%;transform:translateX(-50%);z-index:50;transition:.5s}
#toggle:checked{bottom:200px;transform:translateX(-50%) translateY(50%)}
#menu{position:fixed;bottom:-200px;height:200px;width:100%;border-top:1px solid;z-index:2;transition:.5s}
#toggle:checked~#menu{bottom:0}
#toggle:checked~.CodeMirror,#toggle:checked~#iframe{height:calc(100% - 200px);bottom:0}
#myconsole{float:right;height:200px;width:calc(100% - 90px);border-left:1px solid;padding:5px;-moz-control-character-visibility:visible;resize:none}
button{display:block;border:1px solid;margin:5px;padding:3px 0;width:80px;cursor:pointer}
button:active{background:#aaa}
</style>
<input type=checkbox id=toggle title="Toggle dev tools">
<textarea id=code>&lt;body id=b>
  &lt;style>*{color:blue}&lt;/style>
  Hello World!
  &lt;script>console.log("ok")&lt;/script>
&lt;/body></textarea>
<iframe id=iframe></iframe>
<div id=menu>
  <textarea id=myconsole></textarea>
  <button id=save>Save</button>
  <button id=load>Load</button>
  <button id=share>Share</button>
  <button id=minify>Minify</button>
  <button id=pack>Pack</button>
  <button id=minpack>Min+pack</button>
</div>
<script>

// Custom_console
custom_console="<script>console.old_log=console.log;console.log=function(text){top.myconsole.innerHTML+=text+'\\n';top.myconsole.scrollTop=1e8;console.old_log(text)};console.old_clear=console.clear;console.clear=function(){ top.myconsole.innerHTML='';console.old_clear()}<\/script>";

console.old_log=console.log;

console.log=function(text){
  top.myconsole.innerHTML+=text+'\n';top.myconsole.scrollTop=1e8;console.old_log(text);
}

console.old_clear=console.clear;

console.clear=function(){
  top.myconsole.innerHTML='';console.old_clear();
}

// Read hash
if(location.hash){
  code.value=decodeURI(location.hash.slice(1));location.hash="";
}

// Use CodeMirror
editor=CodeMirror.fromTextArea(code,{lineNumbers:true,lineWrapping:true,mode:"htmlmixed"});

// Update iframe
iframe.srcdoc=custom_console+editor.getValue();

// After typing code, clear console and update iframe
editor.on("keyup",function(){
  console.clear();
  iframe.srcdoc=custom_console+editor.getValue();
});

// Save
save.onclick=function(){
  localStorage["code"]=editor.getValue();
}

// Load
load.onclick=function(){
  editor.setValue(localStorage["code"]);
}

// Shate
share.onclick=function(){
  myconsole.innerHTML="http://codegolf.github.io/codegolfIDE/#"+encodeURI(editor.getValue());
}

// Minify
minify.onclick=function(){
  console.clear();
  input=/<script>([^]*?)<\/script>/gm.exec(editor.getValue())[1];
  xhr=new XMLHttpRequest();
  xhr.open("POST", "https://closure-compiler.appspot.com/compile", true);
  xhr.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");  
  xhr.send("language=ECMASCRIPT6&output_info=compiled_code&js_code="+encodeURI(input));
  xhr.onload=function(){
    min=xhr.response.replace(/\r|\n|(;*\n*$)/,"");
    console.log(min+"\n\n// "+min.length+" chars minified (original: "+input.length+")");
  }
}

// Pack
regpack=function(input){
	options={withMath:false,hash2DContext:false,hashWebGLContext:false,hashAudioContext:false,contextVariableName:false,contextType:0,reassignVars:false,varsNotReassigned:[],crushGainFactor:1,crushLengthFactor:0,crushCopiesFactor:0,crushTiebreakerFactor:1,wrapInSetInterval:false,timeVariableName:""};
  inputList=packer.runPacker(input,options);
  results=inputList[0].result;
  shortest=0;
  shortest_bytes=1e8;
  for(i=0;i<results.length;i++){
    if(results[i][0]<shortest_bytes){
      shortest=i;
      shortest_bytes=results[i][0];
    }
  }
  return results[shortest][1];
}

pack.onclick=function(){
  console.clear();
  input=/<script>([^]*?)<\/script>/gm.exec(editor.getValue())[1];
  min=regpack(input);
  console.log(min+"\n\n// "+min.length+" chars packed (original: "+input.length+")");
}

// Min + pack
minpack.onclick=function(){
  console.clear();
  input=/<script>([^]*?)<\/script>/gm.exec(editor.getValue())[1];
  xhr=new XMLHttpRequest();
  xhr.open("POST", "https://closure-compiler.appspot.com/compile", true);
  xhr.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");  
  xhr.send("language=ECMASCRIPT6&output_info=compiled_code&js_code="+encodeURI(input));
  xhr.onload=function(){
    min=xhr.response.replace(/\r|\n|(;*\n*$)/,"");
    min=regpack(min);
    console.log(min+"\n\n// "+min.length+" chars minified + packed (original: "+input.length+")");
  }
}
</script>