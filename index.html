<!doctype html>
<meta charset=utf-8>
<title>Codegolf IDE</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.11.0/codemirror.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.11.0/codemirror.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.11.0/mode/xml/xml.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.11.0/mode/javascript/javascript.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.11.0/mode/css/css.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.11.0/mode/htmlmixed/htmlmixed.js"></script>
<style>
*{margin:0;padding:0;border:0;box-sizing:border-box}
html,body{height:100%}
.CodeMirror,#iframe{width:50%;height:100%;float:left;transition:.5s}
#iframe{border-left:1px solid}
#toggle{position:fixed;bottom:0;left:50%;transform:translateX(-50%);z-index:3;transition:.5s}
#toggle:checked{bottom:200px;transform:translateX(-50%) translateY(50%)}
#menu{position:fixed;bottom:-200px;height:200px;width:100%;border-top:1px solid;z-index:2;transition:.5s}
#toggle:checked~#menu{bottom:0}
#toggle:checked~.CodeMirror,#toggle:checked~#iframe{height:calc(100% - 200px);bottom:0}
#myconsole{float:right;height:200px;width:calc(100% - 90px);border-left:1px solid;padding:5px}
button{display:block;border:1px solid;margin:5px;padding:3px 0;width:80px;cursor:pointer}
button:active{background:#aaa}
</style>
<input type=checkbox id=toggle title="Toggle dev tools">
<textarea id=code>&lt;body id=b>
  &lt;style>*{color:blue}&lt;/style>
  Hello World!
  &lt;script>console.log("ok")&lt;/script>
&lt;/body></textarea>
<iframe id=iframe></iframe>
<div id=menu>
  <textarea id=myconsole></textarea>
  <button id=save>Save</button>
  <button id=load>Load</button>
  <button id=share>Share</button>
  <button id=minify>Minify</button>
  <button id=pack disabled>Pack</button>
  <button id=minpack disabled>Min+pack</button>
</div>
<script>

// CodeMirror editor
var editor;

// Custom_console
var custom_console="<script>console.old_log=console.log;console.log=function(text){top.myconsole.innerHTML+=text+'\\n';console.old_log(text)}<\/script>";

// On load, retrieve hash, init CodeMirror, update iframe
onload=function(){
  if(location.hash)code.value=decodeURI(location.hash.slice(1));
  editor=CodeMirror.fromTextArea(code,{lineNumbers:true,lineWrapping:true,mode:"htmlmixed"});
  iframe.srcdoc=custom_console+editor.getValue();
  location.hash="";
};

// After typing code, clear console (fails on Fx) and update iframe
onkeyup=function(){
  console.clear();
  myconsole.innerHTML="";
  iframe.srcdoc=custom_console+editor.getValue();
};

// Save
save.onclick=function(){
  localStorage["code"]=editor.getValue();
}

// Load
load.onclick=function(){
  editor.setValue(localStorage["code"]);
}

// Shate
share.onclick=function(){
  myconsole.innerHTML="http://codegolf.github.io/codegolfIDE/#"+encodeURI(editor.getValue());
}

// Minify
minify.onclick=function(){
  js_code=/<script>(.*?)<\/script>/g.exec(editor.getValue())[1];
  xhr=new XMLHttpRequest();
  xhr.open("POST", "https://closure-compiler.appspot.com/compile", true);
  xhr.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");  
  xhr.send("language=ECMASCRIPT6&output_info=compiled_code&js_code="+encodeURI(js_code));
  xhr.onload=function(){
    min=xhr.response.replace(/\r|\n|;*\n*$/,"");
    myconsole.innerHTML=min+"\n\n// "+min.length+" bytes";
  }
}
</script>